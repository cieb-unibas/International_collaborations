<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.2.1/math.min.js"></script>
<link rel="stylesheet" href="style.css" type="text/css" />
  
<!-- javascript function for the coefficient plot-->
<script>
  
function round(value, decimals) {
  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
}

Plotly.d3.csv("dat_coeff.csv", function(err, rows){
function unpack(rows, key) {
        return rows.map(function(row) { return row[key]; });
    }

var     var1 = unpack(rows, 'term'),
        var2 = unpack(rows, 'model'),
        ctry_name = unpack(rows, 'ctry_name'),
        est = unpack(rows, 'estimate'),
        conf_l = unpack(rows, 'conf_int'),
        conf_h = unpack(rows, 'conf.high'),
        conf_low = unpack(rows, 'conf.low'),
        p_value = unpack(rows, 'p.value'),
        listVar1 = [],
        listVar2 = [],
        currentest = [],
        currentctry = [],
        currentmodel = [],
        currentconf_l = [],
        currentconf_h = [],
        current_ctry_model = [],
        confl = [],
        text_var = [],
        color_var = [],
        current_color = [];
        
        
    for (var i = 0; i < var2.length; i++ ){
        if (listVar2.indexOf(var2[i]) === -1 ){
            listVar2.push(var2[i]);
        }
    }
    
    
      for (var i = 0; i < var1.length; i++ ){
        if (listVar1.indexOf(var1[i]) === -1 ){
            listVar1.push(var1[i]);
        }
    }
      

    function getCountryData(chosenCountry, chosenCountry2) {
        currentest = [];
        currentconf_l = [];
        currentconf_h = [];
        currentctry = [];
        currentmodel = [];
        current_ctry_model = [];
        text_var =[];
        confl = [];
        color_var = [];
        current_color = [];
        
        for (var i = 0 ; i < var1.length ; i++){
           if(var2[i] === "Overall"){
           color_var[i] = d3.interpolateViridis(0);
           } else if (var2[i] === "Chemistry"){
           color_var[i] = d3.interpolateViridis(0.2);
           } else if (var2[i] === "Electrical engineering"){
            color_var[i] = d3.interpolateViridis(0.4);
           } else if (var2[i] === "Instruments"){
           color_var[i] = d3.interpolateViridis(0.6);
           } else if (var2[i] === "Other fields"){
           color_var[i] = d3.interpolateViridis(0.8);
           } else if (var2[i] === "Mechanical engineering"){
           color_var[i] = d3.interpolateViridis(1);
           } 

          for(var j = 0; j < var2.length; j ++){
          for(var k = 0; k < var1.length; k++){
            if (var1[i] === chosenCountry[j] && var2[i] === chosenCountry2[k]) {
                currentest.push(est[i]);
                currentctry.push(var1[i]);
                currentmodel.push(var2[i]);
                currentconf_l.push(conf_l[i]);
                currentconf_h.push(conf_h[i]);
                current_ctry_model.push(var1[i] + "-" + var2[i]);
                current_color.push(color_var[i]);

                text_var.push('Country: ' + ctry_name[i] + '<br>' +  'Technology: ' + var2[i] + '<br>' + 'Estimated coefficient: ' + round(est[i], 4) +
                    '<br>' +  'P-value: ' + p_value[i] +'<br>' + '95% Confidence Intervall: [' + round(conf_low[i], 4) + ', ' + round(conf_h[i], 4) + ']');
                
          }
    }
    }
}
}
// Default Country Data
setBubblePlot(["CH", "GB", "US", "CN", "DE"], ["Overall"]);

function setBubblePlot(chosenCountry, chosenCountry2) {
        getCountryData(chosenCountry, chosenCountry2);
 
 
var trace1 = {
            x: currentest,
            y: [currentctry, currentmodel],
            customdata: text_var,
            type: 'scatter',
            mode: "markers+text",
            color: current_color,
            text:  currentctry,
            marker: {size: 20, color: current_color},
            error_x: {
            type: 'data', color: current_color,
            array: currentconf_l},
            orientation: 'h',
            hovertemplate:  '%{customdata}' + '<extra></extra>',
            textposition: 'top',
        };
        
        

                  

var data = [trace1];
 
var layout = {
          hovermode: "closest",
          hoverlabel: { bgcolor: "#FFF" },
        //  bargap: 0.4,
        //  bargroupgap:  0.1, 
          showlegend: false,
          scrollZoom: false,
          height: 60 + 40*currentest.length,
          margin: {l: 300,
                   r: 0,
                   b: 50,
                   t: 0},
           shapes: [{
    type: 'line',
    x0: 0,
    y0: -1,
    x1: 0,
    y1: current_ctry_model.length + 1,
    line: {
      color: 'grey',
      width: 1.5,
      dash: 'dash'
    }}],       
                 
    xaxis: {autotick: true,
            fixedrange: true,
            zeroline: false,
            autorange: true,
                       // tickvals: [1, 2, 3, 4, 5], 
            tickfont: {size: 18},
            title: {text: '<b>Coefficient estimate</b>', font: {size: 18}}
           },
    yaxis: {autotick: false,
            showgrid: false,
            fixedrange: true,
            zeroline: false,
            showticklabels: true,
             categoryorder: "array",
            categoryarry: currentmodel, 
            tickfont: {size: 18, width: 2},
            title: {text: '<b></b>'}}

  
};
  

Plotly.newPlot('myDiv', data, layout, {displayModeBar: false});
//Plotly.update('myDiv', data, layout);
}


var countrySelector = document.getElementById("select_1");
var countrySelector2 = document.getElementById("select_2");




//function assignOptions(textArray, selector) {
//        for (var i = 0; i < textArray.length-1;  i++) {
//            var currentOption = document.createElement("option");
//            currentOption.text = textArray[i];
//            selector.appendChild(currentOption);
//        }
//    }


//assignOptions(listVar1, countrySelector);
//assignOptions(listVar2, countrySelector2);

function updateCountry(){
  var var_2l = [];
  var var_1l = [];


  $.each($("#select_1 option:selected" ), function() {
  var_2l.push($(this).val());  
  })
  
    $.each($("#select_2 option:selected" ), function() {
  var_1l.push($(this).val());  
  })
  
setBubblePlot(var_2l, var_1l);
    }


countrySelector.addEventListener('change', updateCountry, false);
countrySelector2.addEventListener('change', updateCountry, false);

});    
  

</script>
</head>

<body>
<div class="showcase__section" id="bubble">
  <div id="bubbleplots">
      <div class="plot" id="plotdiv"></div>
      <div class="control-row">
        <select class="selectpicker" id="select_1" name="select1" multiple="multiple" data-actions-box="true">
        <option value="AT">Austria</option>   
        <option value="BE">Belgium</option>  
        <option value="CA" selected>Canada</option>
        <option value="CN" selected>China</option>
        <option value="DK">Denmark</option>   
        <option value="ES">Espania</option>   
        <option value="FI">Finland</option>   
        <option value="FR">France</option>   
        <option value="DE" selected>Germany</option>
        <option value="GB" selected>Great Britain</option>
        <option value="IE">Ireland</option>   
        <option value="IL">Israel</option>   
        <option value="IT">Italy</option>  
        <option value="JP">Japan</option>
        <option value="NL">Netherlands</option>
        <option value="NO">Norway</option>
        <option value="SG">Singapur</option>
        <option value="KR">South Korea</option>
        <option value="SE">Sweden</option>
        <option value="CH">Switzerland</option>   
        <option value="US" selected>United States</option>
        <option value="REST">Rest</option>
        </select>
    </div>
  </div>
</div>


<div class="showcase__section" id="bubble_2">
  <div id="bubbleplots_2">
      <div class="plot" id="plotdiv_2"></div>
      <div class="control-row">
        <select class="selectpicker" id="select_2" name="select2" multiple="multiple" data-actions-box="true">
        <option selected>Overall</option> 
        <option>Chemistry</option>   
        <option>Electrical engineering</option>   
        <option>Instruments</option>   
        <option>Mechanical engineering</option>   
        <option>Other fields</option>   
       </select>
    </div>
  </div>
</div>



<div id='select_1'></div>
<div id='select_2'></div>



<div id="myDiv"></div>


</body>